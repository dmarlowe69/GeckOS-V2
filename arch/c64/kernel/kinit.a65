/****************************************************************************
   
    OS/A65 Version 2.0.0
    Multitasking Operating System for 6502 Computers

    Copyright (C) 1989-1998 Andre Fachat 

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

****************************************************************************/

/***************************************************************************
 *
 * This file is included in the RESET routine of the kernel,
 * after the "sei:cld". The routine starting at the bginning
 * of this file must initialize the hardware to the system RAM
 * in the beginning and the system ROM in the end of the memory
 * map. Also the system stack (pointer) is setup. 
 * 
 * In addition to that the system interrupt timer (needed for 
 * task preemtion) must be setup.
 *
 * After that the file must define the following macros:
 *
 * GETFREQ()		returns a=0 for 1Mhz, a=128 for 2MHz
 * LEDPORT		address of LED port to signal hardware failures
 * LED_LED		bit of LED bit in LEDPORT address
 * H_ERROR()		if LEDPORT is not defined, then H_ERROR replaces
 *			the LED toggle routine if needed.
 * CLRTIMER()		clear the system interrupt timer interrupt
 *			or outside. Is checked by "BNE IRQ_in_Kernel" 
 * SAVEMEM()		save system mem config for interrupt
 * RESTOREMEM()		restore system mem config after interrupt
 * STARTMEM()           This is used to alloc/enable memory pages found
 *                      during kernel init. Takes mem size in AC as given
 *                      by the kernel init. It is called _after_ inimem!
 */

/* Kernel routines for C64 hardware */

/*
 * init stack pointer for system stack
 */
	  ldx #<-1
	  txs

/*
 * init memory configuration
 */
	  lda #7
	  sta 0		/* CPU data direction register */
	  lda #5
	  sta 1		/* Memory configuration */

/* 
 * C64 specific irq timer init, irq every screen
 */
	lda #%01111111
	sta C64CIA1+CIA_ICR	; disable system timer irq

	and $d011		; clear most significant bit in VIC raster
	sta $d011
	
	lda #1			; raster line to use
	sta $d012

	lda #%00000001
	sta $d01a		; enable the raster interrupt
	
/*
 * check zeropage RAM, jump to he_zero if failure
 */
;#include "kernel/zerotest.a65"

/*
 * check system RAM up to ROMSTART, jump to he_ram if failure
 * returns available RAM in 256 byte blocks in AC
 */
;	.zero
;cnt	.byt 0
;	.text
;#include "kernel/ramtest.a65"
;	cmp #MIN_MEM
;	bcc he_ram

/*
 * originally SYSPORT specific, they have a value for the C64 also...
 */
#define	GETFREQ()	lda #0

#define	LEDPORT		$d020
#define	LED_LED		1

/* 
 * as we have set the VIC irq in the kernel, we have to clear the
 * VIC interrupt flag. 
 *
 * Note, this asl on the VIC interrupt latch register does two things:
 * 1) it writes a zero into bit 0, which is the rasterline interrupt timer bit,
 *    thus acknoledging the interrupt
 * 2) it moves bit 7 into C, so if after CHECKTIMER C=1, then it's a timer interrupt
 *
 */
;#define	CLRTIMER()	asl $d019
#define	CHECKTIMER()	asl $d019

/*
 * MMU systems may map task pages into kernel mem to make copying 
 * easier. This mapping has to be preserved during interrupt.
 * SAVEMEM() saves the memory configuration, while RESTOREMEM() 
 * restores it, obviously.
 * These routines are called _after_ "jsr memsys", so this routine
 * has to preserve this mapping when called from kernel space,
 * and so must memtask.
 */

#undef	SAVEMEM
#undef	RESTOREMEM

/* 
 * no memory management...
 */
#define	STARTMEM()


